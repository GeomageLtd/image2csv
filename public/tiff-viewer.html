<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geomage - TIFF Viewer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üñäÔ∏è</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>
    <style>
        .tiff-viewer-container {
            max-width: 100%;
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0;
            padding: 20px;
            box-shadow: none;
            backdrop-filter: blur(10px);
            min-height: 100vh;
        }

        .tiff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .tiff-title {
            color: white;
            font-size: 2em;
            margin: 0;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .viewer-section {
            margin-bottom: 30px;
        }

        .image-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            overflow: auto; /* Ensures scrolling works in all directions */
            height: 70vh;
            border: 2px solid #e9ecef;
            position: relative;
            cursor: grab;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }

        .image-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .image-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .image-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }

        .image-container::-webkit-scrollbar-thumb:hover {
            background: #5a6fd8;
        }

        .tiff-image {
            max-width: none;
            max-height: none;
            height: auto;
            border-radius: 8px;
            transition: width 0.2s ease;
            cursor: grab;
            user-select: none;
            display: block;
            position: relative;
        }

        .tiff-image:active {
            cursor: grabbing;
        }

        .viewer-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .upload-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f1f3f4;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #6c757d;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #495057;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #6c757d;
            margin-bottom: 20px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            z-index: -1;
        }

        .file-input-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .file-info {
            font-weight: 600;
            color: #495057;
        }

        .page-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-nav-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 40px;
        }

        .page-nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .page-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .page-info {
            font-weight: 600;
            color: #495057;
            min-width: 120px;
            text-align: center;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zoom-btn {
            background: linear-gradient(45deg, #6f42c1, #6610f2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 35px;
        }

        .zoom-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(111, 66, 193, 0.3);
        }

        .zoom-level {
            font-weight: 600;
            color: #495057;
            min-width: 60px;
            text-align: center;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
            text-align: center;
        }

        .loading-message {
            text-align: center;
            color: #667eea;
            font-weight: 600;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body>
    <div class="tiff-viewer-container">
        <div class="tiff-header">
            <h1 class="tiff-title">üìÑ TIFF Viewer</h1>
            <a href="/" class="back-btn">
                ‚Üê Back to Main
            </a>
        </div>

        <!-- Image viewer section - now at the top -->
        <div class="viewer-section" id="viewerSection" style="display: none;">
            <div class="image-container" id="imageContainer">
                <div class="loading-message" id="loadingMessage">
                    <div class="spinner"></div>
                    Loading TIFF file...
                </div>
                <img id="tiffImage" class="tiff-image" style="display: none;" alt="TIFF Page">
                <div class="error-message" id="errorMessage" style="display: none;">
                    Failed to load TIFF file. Please try another file.
                </div>
            </div>
            
            <!-- Controls moved below the image -->
            <div class="viewer-controls">
                <div class="file-info" id="fileInfo">
                    No file loaded
                </div>
                <div class="page-controls">
                    <button class="page-nav-btn" id="prevBtn" onclick="previousPage()">‚Äπ</button>
                    <div class="page-info" id="pageInfo">Page 1 / 1</div>
                    <button class="page-nav-btn" id="nextBtn" onclick="nextPage()">‚Ä∫</button>
                </div>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="resetZoom()">‚åÇ</button>
                    <small style="margin-left: 15px; color: #6c757d;">üñ±Ô∏è Scroll to zoom</small>
                </div>
            </div>
        </div>

        <!-- Upload area moved to bottom -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Upload TIFF File</div>
            <div class="upload-hint">Drag and drop your TIFF file here or click to browse</div>
            <div class="file-input-wrapper">
                <input type="file" id="tiffInput" class="file-input" accept=".tif,.tiff" onchange="handleFileSelect(event)">
                <button class="file-input-btn" onclick="document.getElementById('tiffInput').click()">
                    üìÅ Choose File
                </button>
            </div>
        </div>
    </div>

    <script>
        let tiffData = null;
        let tiffBuffer = null; // Store the ArrayBuffer for decoding
        let currentPage = 0;
        let totalPages = 0;
        let currentZoom = 1;
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const tiffInput = document.getElementById('tiffInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.includes('tif')) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            const fileInfo = document.getElementById('fileInfo');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const viewerSection = document.getElementById('viewerSection');
            const tiffImage = document.getElementById('tiffImage');

            // Show viewer section and loading state
            viewerSection.style.display = 'block';
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            tiffImage.style.display = 'none';

            // Update file info
            fileInfo.textContent = `File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;

            // Read the file
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    tiffBuffer = arrayBuffer; // Store for later use
                    const ifds = UTIF.decode(arrayBuffer);
                    
                    if (ifds.length === 0) {
                        throw new Error('No pages found in TIFF file');
                    }

                    // Store the raw TIFF data and page info without decoding all pages
                    tiffData = ifds;
                    totalPages = ifds.length;
                    currentPage = 0;

                    console.log(`üìÑ TIFF file loaded: ${totalPages} page${totalPages > 1 ? 's' : ''} found`);

                    // Update UI and display first page
                    updatePageInfo();
                    
                    // Use setTimeout to allow UI update before displaying first page
                    setTimeout(() => {
                        displayPage(0);
                    }, 10);
                    
                } catch (error) {
                    console.error('Error processing TIFF:', error);
                    loadingMessage.style.display = 'none';
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = `Error: ${error.message}`;
                }
            };

            reader.onerror = function() {
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Failed to read file';
            };

            reader.readAsArrayBuffer(file);
        }

        function displayPage(pageIndex) {
            if (!tiffData || pageIndex < 0 || pageIndex >= tiffData.length) {
                return;
            }

            // Show loading state for page switching
            const tiffImage = document.getElementById('tiffImage');
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            
            tiffImage.style.display = 'none';
            errorMessage.style.display = 'none';
            loadingMessage.style.display = 'block';
            loadingMessage.innerHTML = '<div class="spinner"></div>Loading page...';

            // Use setTimeout to allow UI update before processing
            setTimeout(() => {
                try {
                    const ifd = tiffData[pageIndex];
                    
                    // First decode the image data (this is necessary!)
                    UTIF.decodeImage(tiffBuffer, ifd);
                    
                    // Use the same efficient approach as the main page
                    const canvas = document.createElement('canvas');
                    canvas.width = ifd.width;
                    canvas.height = ifd.height;
                    const ctx = canvas.getContext('2d');
                    
                    // Create ImageData and use UTIF's efficient conversion
                    const imageData = ctx.createImageData(ifd.width, ifd.height);
                    const rgba = UTIF.toRGBA8(ifd);
                    imageData.data.set(rgba);
                    ctx.putImageData(imageData, 0, 0);
                    
                    tiffImage.src = canvas.toDataURL();
                    tiffImage.style.display = 'block';
                    
                    // Reset zoom to 1 and apply proper sizing
                    currentZoom = 1;
                    updateZoom();
                    
                    // Center the image in the container
                    centerImage();
                    
                    currentPage = pageIndex;
                    updatePageInfo();
                    
                    loadingMessage.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error displaying page:', error);
                    loadingMessage.style.display = 'none';
                    errorMessage.style.display = 'block';
                    errorMessage.textContent = `Error displaying page: ${error.message}`;
                }
            }, 10); // Small delay to allow UI update
        }

        function updatePageInfo() {
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            pageInfo.textContent = `Page ${currentPage + 1} / ${totalPages}`;
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === totalPages - 1;
        }

        function previousPage() {
            if (currentPage > 0) {
                displayPage(currentPage - 1);
            }
        }

        function nextPage() {
            if (currentPage < totalPages - 1) {
                displayPage(currentPage + 1);
            }
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.1, 10);
            updateZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.1, 0.1);
            updateZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            updateZoom();
            centerImage(); // Center the image when resetting zoom
        }

        function centerImage() {
            // Center the image in the container
            const container = document.getElementById('imageContainer');
            const image = document.getElementById('tiffImage');
            
            if (image.src) {
                setTimeout(() => {
                    // Get container dimensions
                    const containerWidth = container.clientWidth;
                    const containerHeight = container.clientHeight;
                    
                    // Get actual image dimensions (now using real width/height)
                    const imageWidth = image.offsetWidth;
                    const imageHeight = image.offsetHeight;
                    
                    // Calculate scroll position to center the image
                    const scrollLeft = Math.max(0, (imageWidth - containerWidth) / 2);
                    const scrollTop = Math.max(0, (imageHeight - containerHeight) / 2);
                    
                    // Apply scroll position
                    container.scrollLeft = scrollLeft;
                    container.scrollTop = scrollTop;
                }, 100); // Slightly longer delay for image resize
            }
        }

        function updateZoom() {
            const tiffImage = document.getElementById('tiffImage');
            const zoomLevel = document.getElementById('zoomLevel');
            
            if (tiffImage.src) {
                const container = document.getElementById('imageContainer');
                const containerWidth = container.clientWidth - 40; // Subtract padding
                
                // Calculate actual dimensions based on zoom
                const baseWidth = containerWidth;
                const actualWidth = baseWidth * currentZoom;
                
                // Use actual width/height instead of transform for proper scrolling
                tiffImage.style.width = `${actualWidth}px`;
                tiffImage.style.height = 'auto';
                tiffImage.style.transform = 'none'; // Remove transform
                
                // Center horizontally only at 100% zoom
                if (currentZoom === 1) {
                    tiffImage.style.margin = '0 auto';
                } else {
                    tiffImage.style.margin = '0';
                }
            }
            
            zoomLevel.textContent = `${Math.round(currentZoom * 100)}%`;
        }

        // Add panning functionality
        const imageContainer = document.getElementById('imageContainer');
        
        // Scroll to zoom functionality
        imageContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            
            // Get mouse position relative to the container
            const rect = imageContainer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            // Get current scroll position and mouse position relative to the image
            const scrollX = imageContainer.scrollLeft + mouseX;
            const scrollY = imageContainer.scrollTop + mouseY;
            
            // Get current image dimensions
            const tiffImage = document.getElementById('tiffImage');
            const currentImageWidth = tiffImage.offsetWidth;
            const currentImageHeight = tiffImage.offsetHeight;
            
            // Calculate mouse position as percentage of current image
            const mouseXPercent = scrollX / currentImageWidth;
            const mouseYPercent = scrollY / currentImageHeight;
            
            const oldZoom = currentZoom;
            
            if (e.deltaY < 0) {
                // Scroll up - zoom in
                zoomIn();
            } else {
                // Scroll down - zoom out
                zoomOut();
            }
            
            // Adjust scroll position after zoom change
            if (currentZoom !== oldZoom) {
                setTimeout(() => {
                    const newImageWidth = tiffImage.offsetWidth;
                    const newImageHeight = tiffImage.offsetHeight;
                    
                    // Calculate new scroll position to keep mouse position fixed
                    const newScrollX = (mouseXPercent * newImageWidth) - mouseX;
                    const newScrollY = (mouseYPercent * newImageHeight) - mouseY;
                    
                    imageContainer.scrollLeft = Math.max(0, newScrollX);
                    imageContainer.scrollTop = Math.max(0, newScrollY);
                }, 10); // Small delay to let the image resize
            }
        });
        
        imageContainer.addEventListener('mousedown', (e) => {
            // Always allow dragging regardless of zoom level
            isDragging = true;
            startX = e.pageX - imageContainer.offsetLeft;
            startY = e.pageY - imageContainer.offsetTop;
            scrollLeft = imageContainer.scrollLeft;
            scrollTop = imageContainer.scrollTop;
            imageContainer.style.cursor = 'grabbing';
            e.preventDefault(); // Prevent text selection
        });

        imageContainer.addEventListener('mouseleave', () => {
            isDragging = false;
            imageContainer.style.cursor = 'grab';
        });

        imageContainer.addEventListener('mouseup', () => {
            isDragging = false;
            imageContainer.style.cursor = 'grab';
        });

        imageContainer.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.pageX - imageContainer.offsetLeft;
            const y = e.pageY - imageContainer.offsetTop;
            const walkX = (x - startX) * 2;
            const walkY = (y - startY) * 2;
            imageContainer.scrollLeft = scrollLeft - walkX;
            imageContainer.scrollTop = scrollTop - walkY;
        });

        // Prevent context menu on right click
        imageContainer.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (!tiffData) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    previousPage();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextPage();
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    zoomIn();
                    break;
                case '-':
                    e.preventDefault();
                    zoomOut();
                    break;
                case '0':
                    e.preventDefault();
                    resetZoom();
                    break;
            }
        });
    </script>
</body>
</html> 